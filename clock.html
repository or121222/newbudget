<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <script>
    window.onerror = function(message, source, lineno, colno, error) {
        alert("שגיאה באפליקציה:\n" + message + "\nשורה: " + lineno);
    };
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>שעון נוכחות</title>
    <link rel="stylesheet" href="style.css"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* התאמות ספציפיות לשעון */
        body { padding: 20px; padding-bottom: 100px; display: flex; flex-direction: column; min-height: 100vh; }
        
        .clock-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; }
        .back-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-main); cursor: pointer; padding: 5px; }

        /* השעון הגדול */
        .timer-display-container {
            width: 280px; height: 280px; border-radius: 50%;
            background: var(--card-bg); margin: 0 auto 30px auto;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: var(--shadow); border: 8px solid rgba(0,0,0,0.03);
            transition: all 0.3s ease; position: relative;
        }
        .timer-display-container.running { border-color: var(--success); box-shadow: 0 0 25px rgba(0, 184, 148, 0.3); }

        .timer-val { font-size: 4rem; font-weight: 700; letter-spacing: 2px; font-variant-numeric: tabular-nums; line-height: 1; color: var(--text-main); }
        .timer-live-money { font-size: 1.5rem; color: var(--success); font-weight: bold; margin-top: 5px; direction: ltr; }
        .timer-status { text-transform: uppercase; font-size: 0.85rem; color: var(--text-sec); letter-spacing: 1px; margin-bottom: 5px; }

        /* כפתור הפעלה ראשי */
        .main-action-btn {
            width: 90px; height: 90px; border-radius: 50%; border: none;
            font-size: 2rem; color: white; cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            margin: -45px auto 30px auto; /* עולה על השעון */
            position: relative; z-index: 10;
            transition: transform 0.1s;
        }
        .main-action-btn:active { transform: scale(0.95); }
        .btn-start { background: var(--success); }
        .btn-stop { background: var(--danger); }

        /* כרטיס סיכום תחתון */
        .summary-card {
            background: var(--primary); color: white;
            border-radius: 20px; padding: 20px;
            margin-top: auto; /* דוחף למטה */
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        .summary-title { font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px; }
        .summary-amount { font-size: 2.5rem; font-weight: bold; direction: ltr; }
        .summary-hours { font-size: 0.9rem; opacity: 0.9; }

        /* Modal Styles override */
        .shift-type-select { width: 100%; padding: 15px; border-radius: 12px; background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); font-size: 1.1rem; margin: 15px 0; color: var(--text-main); }
    </style>
</head>
<body class="page active"> <div class="clock-header">
        <button class="back-btn" onclick="window.location.href='index.html'"><i class="fas fa-arrow-right"></i></button>
        <h2 style="margin:0;">שעון נוכחות</h2>
        <div style="width: 24px;"></div>
    </div>

    <div class="timer-display-container" id="clock-circle">
        <div class="timer-status" id="status-text">מוכן לעבודה</div>
        <div class="timer-val" id="display-time">00:00:00</div>
        <div class="timer-live-money" id="display-money">₪0.00</div>
    </div>

    <button id="action-btn" class="main-action-btn btn-start" onclick="toggleClock()">
        <i class="fas fa-play"></i>
    </button>

    <div style="text-align:center; color:var(--text-sec); font-size:0.9rem;">
        תעריף לשעה: <span id="rate-lbl" style="font-weight:bold;">0</span> ₪
    </div>

    <div class="summary-card">
        <div class="summary-title">משכורת מצטברת (חודש נוכחי)</div>
        <div class="summary-amount" id="total-month-money">₪0.00</div>
        <div class="summary-hours" id="total-month-hours">סה"כ שעות: 0</div>
    </div>

    <div id="end-shift-modal" class="modal-overlay">
        <div class="modal-card">
            <h3>סיום משמרת</h3>
            <p style="color:var(--text-sec); margin-bottom:10px;">סיימת לעבוד! איך נחשב את המשמרת?</p>
            
            <div style="text-align:right; margin-bottom:5px; font-size:0.9rem;">סוג משמרת:</div>
            <select id="shift-type-select" class="shift-type-select"></select>
            
            <div style="background:rgba(0,184,148,0.1); padding:15px; border-radius:10px; margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>זמן כולל:</span>
                    <span id="modal-time" style="font-weight:bold">00:00</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:bold; color:var(--success);">
                    <span>שכר משוער:</span>
                    <span id="modal-money">₪0.00</span>
                </div>
            </div>

            <button class="btn-primary" onclick="saveShift()" style="margin-bottom:10px;">שמור משמרת</button>
            <button class="btn-primary" onclick="discardShift()" style="background:transparent; color:var(--text-sec); border:1px solid rgba(0,0,0,0.1);">ביטול (לא לשמור)</button>
        </div>
    </div>

    <script>
        // === משתנים ===
        let timerInterval;
        let startTime = 0;
        let hourlyRate = 0;
        let categories = [];
        let shiftHistory = JSON.parse(localStorage.getItem('neto_shift_history')) || [];

        // === אתחול ===
        document.addEventListener('DOMContentLoaded', () => {
            // 1. טעינת הגדרות (ערכת נושא)
            const appSettings = JSON.parse(localStorage.getItem('budgetUltimateDataV23'))?.settings;
            if(appSettings?.theme) document.body.className = `page active theme-${appSettings.theme}`;
            if(localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');

            // 2. טעינת שכר וקטגוריות מהאפליקציה הראשית
            try {
                const sscCfg = JSON.parse(localStorage.getItem('ssc:cfg'));
                if(sscCfg && sscCfg.hourly) hourlyRate = parseFloat(sscCfg.hourly);
                
                const sharedCats = JSON.parse(localStorage.getItem('ssc:shared_categories'));
                if(sharedCats) categories = sharedCats;
                else categories = [{id:'def', name:'רגיל', slices:[{p:100, h:99}]}]; // ברירת מחדל
            } catch(e) {}

            document.getElementById('rate-lbl').innerText = hourlyRate;
            updateTotalSummary();

            // 3. בדיקת מצב קיים
            const savedStart = localStorage.getItem('neto_active_shift_start');
            if(savedStart) {
                startTime = parseInt(savedStart);
                startUI();
            }
        });

        // === לוגיקה ===
        function toggleClock() {
            if(startTime > 0) {
                // עצירה -> פתיחת מודל
                prepareEndModal();
            } else {
                // התחלה
                if(hourlyRate === 0 && !confirm("לא הוגדר שכר לשעה. להמשיך?")) return;
                startTime = Date.now();
                localStorage.setItem('neto_active_shift_start', startTime);
                startUI();
            }
        }

        function startUI() {
            const btn = document.getElementById('action-btn');
            btn.classList.remove('btn-start'); btn.classList.add('btn-stop');
            btn.innerHTML = '<i class="fas fa-stop"></i>';
            
            document.getElementById('clock-circle').classList.add('running');
            document.getElementById('status-text').innerText = "משמרת פעילה";
            
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTick, 1000);
            updateTick(); // עדכון מיידי
        }

        function updateTick() {
            const now = Date.now();
            const diff = now - startTime;
            
            // המרה לשעות:דקות:שניות
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            
            document.getElementById('display-time').innerText = 
                `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            
            // חישוב כסף חי (לפי 100% שכר בסיס בינתיים)
            const earned = (diff / 3600000) * hourlyRate;
            document.getElementById('display-money').innerText = "₪" + earned.toFixed(2);
        }

        // === סיום משמרת ===
        function prepareEndModal() {
            const select = document.getElementById('shift-type-select');
            select.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            // הצגת נתונים ראשוניים במודל
            const now = Date.now();
            const hours = (now - startTime) / 3600000;
            
            // חישוב ראשוני (ברירת מחדל לקטגוריה הראשונה)
            const estimatedPay = calcPay(hours, categories[0]);
            
            document.getElementById('modal-time').innerText = formatTime(now - startTime);
            document.getElementById('modal-money').innerText = "₪" + estimatedPay.toFixed(2);
            
            // האזנה לשינוי סוג משמרת לעדכון המחיר
            select.onchange = () => {
                const cat = categories.find(c => c.id == select.value);
                const newPay = calcPay(hours, cat);
                document.getElementById('modal-money').innerText = "₪" + newPay.toFixed(2);
            };

            document.getElementById('end-shift-modal').classList.add('open');
        }

        function calcPay(hours, category) {
            if(!category || !category.slices) return hours * hourlyRate;
            
            let totalPay = 0;
            let hoursLeft = hours;
            
            // חישוב מדרגות (למשל: 8 שעות 100%, שעתיים 125%...)
            for(let slice of category.slices) {
                let h = Math.min(hoursLeft, slice.h);
                if(h > 0) {
                    totalPay += h * hourlyRate * (slice.p / 100);
                    hoursLeft -= h;
                }
            }
            // אם נשארו שעות מעבר למדרגות, נניח שהן במדרגה האחרונה או 100%?
            // לצורך הפשטות, שעות נוספות מעבר למוגדר יקבלו את התעריף של המדרגה האחרונה
            if(hoursLeft > 0) {
                const lastSlice = category.slices[category.slices.length-1];
                totalPay += hoursLeft * hourlyRate * (lastSlice.p / 100);
            }
            
            return totalPay;
        }

        function saveShift() {
            const endTime = Date.now();
            const durationMs = endTime - startTime;
            const hours = durationMs / 3600000;
            
            const catId = document.getElementById('shift-type-select').value;
            const cat = categories.find(c => c.id == catId);
            const totalPay = calcPay(hours, cat);
            
            // שמירה להיסטוריה
            const record = {
                id: Date.now(),
                date: new Date(startTime).toISOString(),
                hours: hours,
                money: totalPay,
                catName: cat.name
            };
            
            shiftHistory.push(record);
            localStorage.setItem('neto_shift_history', JSON.stringify(shiftHistory));
            
            resetClock();
            document.getElementById('end-shift-modal').classList.remove('open');
            updateTotalSummary();
        }

        function discardShift() {
            if(confirm("בטוח שברצונך לבטל את המשמרת הזו? הנתונים ימחקו.")) {
                resetClock();
                document.getElementById('end-shift-modal').classList.remove('open');
            }
        }

        function resetClock() {
            startTime = 0;
            localStorage.removeItem('neto_active_shift_start');
            clearInterval(timerInterval);
            
            const btn = document.getElementById('action-btn');
            btn.className = 'main-action-btn btn-start';
            btn.innerHTML = '<i class="fas fa-play"></i>';
            
            document.getElementById('clock-circle').classList.remove('running');
            document.getElementById('status-text').innerText = "מוכן לעבודה";
            document.getElementById('display-time').innerText = "00:00:00";
            document.getElementById('display-money').innerText = "₪0.00";
        }

        function updateTotalSummary() {
            // סיכום חודש נוכחי
            const now = new Date();
            const thisMonth = shiftHistory.filter(s => {
                const d = new Date(s.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
            
            const totalMoney = thisMonth.reduce((sum, s) => sum + s.money, 0);
            const totalHours = thisMonth.reduce((sum, s) => sum + s.hours, 0);
            
            document.getElementById('total-month-money').innerText = "₪" + totalMoney.toLocaleString();
            document.getElementById('total-month-hours').innerText = `סה"כ שעות החודש: ${totalHours.toFixed(2)}`;
        }

        function formatTime(ms) {
            const s = Math.floor((ms / 1000) % 60);
            const m = Math.floor((ms / 60000) % 60);
            const h = Math.floor(ms / 3600000);
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
        }
    </script>
</body>
</html>

