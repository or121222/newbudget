<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>×©×¢×•×Ÿ × ×•×›×—×•×ª</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* === ×ª×•×¡×¤×•×ª ×¢×™×¦×•×‘ ×¡×¤×¦×™×¤×™×•×ª ×œ×©×¢×•×Ÿ === */
        body {
            display: flex; 
            flex-direction: column; 
            min-height: 100vh;
            background-color: var(--bg-color); /* ×©×™××•×© ×‘×¦×‘×¢ ×”×¨×§×¢ ×©×œ ×”××¤×œ×™×§×¦×™×” */
        }

        .clock-page-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: calc(var(--safe-area-top) + 20px) 20px 40px 20px;
            border-radius: 0 0 30px 30px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: -30px; /* ×›×“×™ ×©×”×©×¢×•×Ÿ ×™×¢×œ×” ×§×¦×ª ×¢×œ ×”×›×•×ª×¨×ª */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 40px; height: 40px;
            border-radius: 12px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
        }

        /* ×”×©×¢×•×Ÿ ×”×’×“×•×œ */
        .timer-display-card {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 30px;
            margin: 0 20px 20px 20px;
            box-shadow: var(--shadow);
            border: var(--glass-border);
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .timer-val {
            font-size: 3.5rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            color: var(--text-main);
            margin: 10px 0;
            text-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .timer-money {
            font-size: 1.5rem;
            color: var(--success);
            font-weight: bold;
            direction: ltr;
            background: rgba(0, 184, 148, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
        }

        /* ×›×¤×ª×•×¨ ×”×¤×¢×œ×” ×¢× ×§ */
        .play-btn-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .big-play-btn {
            width: 80px; height: 80px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .big-play-btn:active { transform: scale(0.95); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .big-play-btn.start { background: linear-gradient(135deg, #00b894, #00cec9); }
        .big-play-btn.stop { background: linear-gradient(135deg, #ff7675, #d63031); animation: pulse-red 2s infinite; }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 118, 117, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 118, 117, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 118, 117, 0); }
        }

        /* ×”×™×¡×˜×•×¨×™×” ×•×›×¨×˜×™×¡×™× */
        .info-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin: 10px 20px;
            box-shadow: var(--shadow);
            border: var(--glass-border);
        }

        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .history-item:last-child { border-bottom: none; }
        
        .h-date { font-size: 0.85rem; color: var(--text-sec); margin-bottom: 2px; }
        .h-time { font-weight: bold; color: var(--text-main); }
        .h-earn { font-weight: bold; color: var(--success); direction: ltr; }

        /* ×¡×œ×§×˜ ××¢×•×¦×‘ ×œ××•×“××œ */
        .styled-select {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.1);
            background: var(--bg-color);
            color: var(--text-main);
            font-size: 1rem;
            margin-bottom: 15px;
            outline: none;
        }
    </style>
</head>
<body>

    <div class="clock-page-header">
        <button class="back-btn" onclick="window.location.href='index.html'">
            <i class="fas fa-arrow-right"></i>
        </button>
        <h2 style="margin:0; font-size:1.5rem;">×©×¢×•×Ÿ × ×•×›×—×•×ª</h2>
        <div style="width:40px"></div> </div>

    <div class="timer-display-card">
        <div style="font-size:0.9rem; color:var(--text-sec); letter-spacing:1px; margin-bottom:5px;">×–××Ÿ × ×•×›×—×™</div>
        <div class="timer-val" id="display-time">00:00:00</div>
        <div class="timer-money" id="display-money">â‚ª0.00</div>

        <div class="play-btn-container">
            <button id="action-btn" class="big-play-btn start" onclick="toggleClock()">
                <i class="fas fa-play"></i>
            </button>
        </div>
        
        <div style="margin-top:20px; font-size:0.85rem; color:var(--text-sec);">
            ×ª×¢×¨×™×£ ×©×¢×ª×™: <span id="rate-lbl" style="font-weight:bold; color:var(--text-main);">0</span> â‚ª
        </div>
    </div>

    <div class="info-card">
        <h3 style="margin:0 0 15px 0; font-size:1.1rem; color:var(--primary);">
            <i class="fas fa-chart-pie"></i> ×¡×™×›×•× ×—×•×“×©×™
        </h3>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span>×¡×”"×› ×©×¢×•×ª:</span>
            <span id="total-month-hours" style="font-weight:bold;">0</span>
        </div>
        <div style="display:flex; justify-content:space-between;">
            <span>×©×›×¨ ××©×•×¢×¨:</span>
            <span id="total-month-money" style="font-weight:bold; color:var(--success);">â‚ª0.00</span>
        </div>
    </div>

    <div class="info-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; font-size:1.1rem; color:var(--text-main);">×”×™×¡×˜×•×¨×™×” ××—×¨×•× ×”</h3>
            <button onclick="clearHistory()" style="background:none; border:none; color:var(--danger); font-size:0.85rem;">× ×§×”</button>
        </div>
        <ul class="history-list" id="history-list">
            </ul>
    </div>

    <div id="custom-alert-modal" class="modal-overlay">
        <div class="modal-card">
            <div id="alert-icon" style="font-size:3rem; margin-bottom:15px;">âœ…</div>
            <h3 id="alert-title" style="margin-bottom:10px;">×”×•×“×¢×”</h3>
            <p id="alert-message" style="margin-bottom:25px; color:#666; font-size:1.1rem;">...</p>
            <button class="btn-primary" onclick="closeCustomAlert()">××™×©×•×¨</button>
        </div>
    </div>

    <div id="general-confirm-modal" class="modal-overlay">
        <div class="modal-card">
            <i class="fas fa-question-circle" style="font-size:3rem; color:var(--primary); margin-bottom:10px;"></i>
            <h3 id="gen-confirm-title" style="margin-bottom:10px;">?</h3>
            <p id="gen-confirm-msg" style="margin-bottom:20px; color:#666;">?</p>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn-primary" style="background:#ccc; color:#333; width:auto; padding:10px 25px;" onclick="closeGeneralConfirm()">×‘×™×˜×•×œ</button>
                <button class="btn-primary" style="background:var(--primary); width:auto; padding:10px 25px;" onclick="performGeneralConfirm()">××™×©×•×¨</button>
            </div>
        </div>
    </div>

    <div id="end-shift-modal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="margin-bottom:15px;">×¡×™×•× ××©××¨×ª</h3>
            <p style="color:var(--text-sec); margin-bottom:15px; font-size:0.95rem;">×‘×—×¨ ××ª ×¡×•×’ ×”××©××¨×ª ×œ×—×™×©×•×‘ ××“×•×™×§:</p>
            
            <select id="shift-type-select" class="styled-select"></select>
            
            <div style="background:rgba(0,0,0,0.03); padding:15px; border-radius:12px; margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span>×–××Ÿ ×¢×‘×•×“×”:</span>
                    <span id="modal-time" style="font-weight:bold">00:00</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:bold; color:var(--success);">
                    <span>×©×›×¨:</span>
                    <span id="modal-money">â‚ª0.00</span>
                </div>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn-primary" onclick="discardShift()" style="background:#ccc; color:#333; flex:1;">×‘×™×˜×•×œ</button>
                <button class="btn-primary" onclick="saveShift()" style="flex:1;">×©××•×¨</button>
            </div>
        </div>
    </div>

    <script>
        // === ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ===
        let timerInterval;
        let startTime = 0;
        let hourlyRate = 0;
        let categories = [];
        let shiftHistory = JSON.parse(localStorage.getItem('neto_shift_history')) || [];
        let pendingAction = null; // ×œ××•×“××œ×™×

        // === ××ª×—×•×œ ===
        document.addEventListener('DOMContentLoaded', () => {
            // ×˜×¢×™× ×ª ×”×’×“×¨×•×ª ×¢×™×¦×•×‘ (Dark Mode + Theme)
            try {
                const appData = JSON.parse(localStorage.getItem('budgetUltimateDataV23'));
                if(appData && appData.settings && appData.settings.theme) {
                    document.body.classList.add('theme-' + appData.settings.theme);
                }
            } catch(e) {}
            
            if(localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
            }

            // ×˜×¢×™× ×ª × ×ª×•× ×™ ×©×›×¨
            try {
                const sscCfg = JSON.parse(localStorage.getItem('ssc:cfg'));
                if(sscCfg && sscCfg.hourly) hourlyRate = parseFloat(sscCfg.hourly);
                
                const sharedCats = JSON.parse(localStorage.getItem('ssc:shared_categories'));
                if(sharedCats) categories = sharedCats;
                else categories = [{id:'def', name:'×¨×’×™×œ', slices:[{p:100, h:99}]}]; 
            } catch(e) {}

            document.getElementById('rate-lbl').innerText = hourlyRate;
            updateTotalSummary();
            renderHistory();

            // ×‘×“×™×§×ª ××¦×‘ ×¤×¢×™×œ
            const savedStart = localStorage.getItem('neto_active_shift_start');
            if(savedStart) {
                startTime = parseInt(savedStart);
                startUI();
            }
        });

        // === ×œ×•×’×™×§×” ===
        function toggleClock() {
            if(startTime > 0) {
                // ×¢×¦×™×¨×”
                prepareEndModal();
            } else {
                // ×”×ª×—×œ×”
                if(hourlyRate === 0) {
                    showConfirmDialog("×©×™× ×œ×‘", "×œ× ×”×•×’×“×¨ ×©×›×¨ ×œ×©×¢×” ×‘××—×©×‘×•×Ÿ. ×œ×”××©×™×š?", function() {
                        startClockAction();
                    });
                } else {
                    startClockAction();
                }
            }
        }

        function startClockAction() {
            startTime = Date.now();
            localStorage.setItem('neto_active_shift_start', startTime);
            startUI();
        }

        function startUI() {
            const btn = document.getElementById('action-btn');
            btn.classList.remove('start');
            btn.classList.add('stop');
            btn.innerHTML = '<i class="fas fa-stop"></i>';
            
            document.querySelector('.timer-display-card').style.borderColor = 'var(--success)';
            
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTick, 1000);
            updateTick();
        }

        function updateTick() {
            const now = Date.now();
            const diff = now - startTime;
            
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            
            document.getElementById('display-time').innerText = 
                `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            
            const earned = (diff / 3600000) * hourlyRate;
            document.getElementById('display-money').innerText = "â‚ª" + earned.toFixed(2);
        }

        // === ×¡×™×•× ×•×—×™×©×•×‘ ===
        function prepareEndModal() {
            const select = document.getElementById('shift-type-select');
            select.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            const now = Date.now();
            const hours = (now - startTime) / 3600000;
            const diff = now - startTime;
            
            // ×¤×•× ×§×¦×™×™×ª ×—×™×©×•×‘ ×¤× ×™××™×ª ×œ××•×“××œ
            const updateModalCalc = () => {
                const cat = categories.find(c => c.id == select.value);
                const pay = calcPay(hours, cat);
                document.getElementById('modal-money').innerText = "â‚ª" + pay.toFixed(2);
            };

            document.getElementById('modal-time').innerText = formatTimeStr(diff);
            updateModalCalc(); // ×—×™×©×•×‘ ×¨××©×•× ×™
            
            select.onchange = updateModalCalc;
            document.getElementById('end-shift-modal').classList.add('open');
        }

        function calcPay(hours, category) {
            if(!category || !category.slices) return hours * hourlyRate;
            let totalPay = 0;
            let hoursLeft = hours;
            
            for(let slice of category.slices) {
                let h = Math.min(hoursLeft, slice.h);
                if(h > 0) {
                    totalPay += h * hourlyRate * (slice.p / 100);
                    hoursLeft -= h;
                }
            }
            if(hoursLeft > 0) {
                const lastSlice = category.slices[category.slices.length-1];
                totalPay += hoursLeft * hourlyRate * (lastSlice.p / 100);
            }
            return totalPay;
        }

        function saveShift() {
            const endTime = Date.now();
            const durationMs = endTime - startTime;
            const hours = durationMs / 3600000;
            
            const catId = document.getElementById('shift-type-select').value;
            const cat = categories.find(c => c.id == catId);
            const totalPay = calcPay(hours, cat);
            
            const record = {
                id: Date.now(),
                date: new Date(startTime),
                hours: hours,
                money: totalPay,
                catName: cat ? cat.name : '×›×œ×œ×™'
            };
            
            shiftHistory.unshift(record); // ×”×•×¡×¤×” ×œ×¨××© ×”×¨×©×™××”
            localStorage.setItem('neto_shift_history', JSON.stringify(shiftHistory));
            
            resetClock();
            document.getElementById('end-shift-modal').classList.remove('open');
            updateTotalSummary();
            renderHistory();
            showAppAlert("× ×©××¨", "×”××©××¨×ª × ×•×¡×¤×” ×‘×”×¦×œ×—×”!", "ğŸ’¾");
        }

        function discardShift() {
            showConfirmDialog("×‘×™×˜×•×œ ××©××¨×ª", "×”× ×ª×•× ×™× ×™×™××—×§×•. ×”×× ××ª×” ×‘×˜×•×—?", function() {
                resetClock();
                document.getElementById('end-shift-modal').classList.remove('open');
            });
        }

        function resetClock() {
            startTime = 0;
            localStorage.removeItem('neto_active_shift_start');
            clearInterval(timerInterval);
            
            const btn = document.getElementById('action-btn');
            btn.className = 'main-action-btn btn-start';
            btn.innerHTML = '<i class="fas fa-play"></i>';
            
            document.querySelector('.timer-display-card').style.borderColor = 'rgba(0,0,0,0.03)';
            document.getElementById('display-time').innerText = "00:00:00";
            document.getElementById('display-money').innerText = "â‚ª0.00";
        }

        function updateTotalSummary() {
            const now = new Date();
            // ×¡×™× ×•×Ÿ ×œ×—×•×“×© ×”× ×•×›×—×™
            const thisMonth = shiftHistory.filter(s => {
                const d = new Date(s.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
            
            const totalMoney = thisMonth.reduce((sum, s) => sum + s.money, 0);
            const totalHours = thisMonth.reduce((sum, s) => sum + s.hours, 0);
            
            document.getElementById('total-month-money').innerText = "â‚ª" + totalMoney.toLocaleString();
            document.getElementById('total-month-hours').innerText = `×¡×”"×› ×©×¢×•×ª ×”×—×•×“×©: ${totalHours.toFixed(2)}`;
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            shiftHistory.slice(0, 5).forEach(shift => { // ××¦×™×’ ×¨×§ 5 ××—×¨×•× ×™×
                const d = new Date(shift.date);
                const dateStr = d.getDate() + '/' + (d.getMonth()+1);
                
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `
                    <div>
                        <div class="h-time">${shift.catName}</div>
                        <div class="h-date">${dateStr} â€¢ ${shift.hours.toFixed(2)} ×©×¢×•×ª</div>
                    </div>
                    <div class="h-earn">â‚ª${shift.money.toFixed(2)}</div>
                `;
                list.appendChild(li);
            });
        }

        function clearHistory() {
            showConfirmDialog("××—×™×§×ª ×”×™×¡×˜×•×¨×™×”", "×”×× ×œ××—×•×§ ××ª ×›×œ × ×ª×•× ×™ ×”××©××¨×•×ª?", function() {
                shiftHistory = [];
                localStorage.removeItem('neto_shift_history');
                renderHistory();
                updateTotalSummary();
            });
        }

        function formatTimeStr(ms) {
            const totalSecs = Math.floor(ms / 1000);
            const h = Math.floor(totalSecs / 3600).toString().padStart(2, '0');
            const m = Math.floor((totalSecs % 3600) / 60).toString().padStart(2, '0');
            return `${h}:${m}`;
        }

        // === ××¢×¨×›×ª ××•×“××œ×™× (Alert/Confirm) ===
        function showAppAlert(title, message, icon) {
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-message').innerText = message;
            document.getElementById('alert-icon').innerText = icon;
            document.getElementById('custom-alert-modal').classList.add('open');
        }
        function closeCustomAlert() {
            document.getElementById('custom-alert-modal').classList.remove('open');
        }
        function showConfirmDialog(title, msg, callback) {
            document.getElementById('gen-confirm-title').innerText = title;
            document.getElementById('gen-confirm-msg').innerText = msg;
            pendingAction = callback;
            document.getElementById('general-confirm-modal').classList.add('open');
        }
        function closeGeneralConfirm() {
            document.getElementById('general-confirm-modal').classList.remove('open');
            pendingAction = null;
        }
        function performGeneralConfirm() {
            if (pendingAction) pendingAction();
            closeGeneralConfirm();
        }
    </script>
</body>
</html>
