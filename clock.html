<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>שעון נוכחות - Neto</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* אותו עיצוב כמו האפליקציה הראשית */
        :root { --primary: #4e54c8; --secondary: #8f94fb; --bg-color: #f0f2f5; --card-bg: rgba(255, 255, 255, 0.95); --text-main: #2d3436; --success: #00b894; --danger: #ff7675; }
        body { font-family: 'Rubik', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; text-align: center; user-select: none; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .back-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-main); cursor: pointer; }
        
        /* השעון עצמו */
        .timer-circle {
            width: 260px; height: 260px; border-radius: 50%;
            background: var(--card-bg); margin: 0 auto 30px auto;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 8px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .timer-circle.active { border-color: var(--success); box-shadow: 0 0 30px rgba(0, 184, 148, 0.4); }
        
        .time-display { font-size: 3.5rem; font-weight: 700; letter-spacing: 2px; font-variant-numeric: tabular-nums; }
        .money-display { font-size: 1.8rem; color: var(--success); font-weight: bold; margin-top: 10px; direction: ltr; }
        .status-text { font-size: 0.9rem; color: #888; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }

        .btn-action {
            width: 80px; height: 80px; border-radius: 50%; border: none;
            color: white; font-size: 2rem; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto; transition: transform 0.2s;
        }
        .btn-action:active { transform: scale(0.9); }
        .start { background: var(--success); }
        .stop { background: var(--danger); }

        /* היסטוריה */
        .history-card { background: var(--card-bg); border-radius: 20px; padding: 20px; margin-top: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); text-align: right; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .history-list { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; }
        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.03); font-size: 0.95rem; }
        .h-date { font-weight: 500; font-size: 0.85rem; color: #666; }
        .h-time { font-weight: bold; }
        .h-money { color: var(--success); font-weight: bold; direction: ltr; }
        
        .delete-btn { color: var(--danger); background: none; border: none; cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <button class="back-btn" onclick="window.location.href='index.html'"><i class="fas fa-arrow-right"></i> חזרה</button>
        <h2 style="margin:0;">שעון נוכחות</h2>
        <div style="width: 24px;"></div> </div>

    <div class="timer-circle" id="circle">
        <div class="time-display" id="time">00:00:00</div>
        <div class="status-text" id="status">לא פעיל</div>
        <div class="money-display" id="money">₪0.00</div>
    </div>

    <button id="toggleBtn" class="btn-action start" onclick="toggleShift()">
        <i class="fas fa-play"></i>
    </button>

    <div style="margin-top: 15px; opacity: 0.6; font-size: 0.9rem;">
        שכר לשעה: <span id="rate-display">0</span> ₪
    </div>

    <div class="history-card">
        <div class="history-header">
            <h3>היסטוריית משמרות</h3>
            <button onclick="clearHistory()" style="background:none; border:none; color:var(--danger); font-size:0.9rem;">נקה הכל</button>
        </div>
        <ul class="history-list" id="history-list">
            </ul>
    </div>

    <script>
        // === לוגיקה ===
        let timerInterval;
        let hourlyRate = 0;
        let shifts = JSON.parse(localStorage.getItem('neto_shifts_history')) || [];

        // טעינה ראשונית
        document.addEventListener('DOMContentLoaded', () => {
            // ניסיון למשוך את השכר מהאפליקציה הראשית
            try {
                const sscConfig = JSON.parse(localStorage.getItem('ssc:cfg'));
                if(sscConfig && sscConfig.hourly) {
                    hourlyRate = parseFloat(sscConfig.hourly);
                }
            } catch(e) {}
            
            document.getElementById('rate-display').innerText = hourlyRate;
            renderHistory();
            
            // בדיקה אם השעון כבר רץ (אם יצאת וחזרת)
            const savedStart = localStorage.getItem('neto_shift_start');
            if(savedStart) {
                resumeTimer(parseInt(savedStart));
            }
        });

        function toggleShift() {
            const btn = document.getElementById('toggleBtn');
            const savedStart = localStorage.getItem('neto_shift_start');

            if (savedStart) {
                // === יציאה ממשמרת (STOP) ===
                const startTime = parseInt(savedStart);
                const endTime = Date.now();
                const durationMs = endTime - startTime;
                
                // חישובים
                const hours = durationMs / (1000 * 60 * 60);
                const earned = hours * hourlyRate;
                
                // שמירה בהיסטוריה
                const shiftRecord = {
                    id: Date.now(),
                    date: new Date(startTime).toLocaleDateString('he-IL'),
                    start: new Date(startTime).toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'}),
                    end: new Date(endTime).toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'}),
                    totalTime: formatTime(durationMs),
                    earned: earned
                };
                
                shifts.unshift(shiftRecord); // הוספה להתחלה
                localStorage.setItem('neto_shifts_history', JSON.stringify(shifts));
                
                // איפוס
                localStorage.removeItem('neto_shift_start');
                clearInterval(timerInterval);
                
                // עדכון UI
                btn.className = 'btn-action start';
                btn.innerHTML = '<i class="fas fa-play"></i>';
                document.getElementById('circle').classList.remove('active');
                document.getElementById('status').innerText = "לא פעיל";
                document.getElementById('time').innerText = "00:00:00";
                document.getElementById('money').innerText = "₪0.00";
                
                renderHistory();

            } else {
                // === כניסה למשמרת (START) ===
                if(hourlyRate === 0) {
                    if(!confirm("שים לב: שכר לשעה הוא 0. להמשיך בכל זאת?")) return;
                }
                
                const now = Date.now();
                localStorage.setItem('neto_shift_start', now);
                resumeTimer(now);
            }
        }

        function resumeTimer(startTime) {
            const btn = document.getElementById('toggleBtn');
            btn.className = 'btn-action stop';
            btn.innerHTML = '<i class="fas fa-stop"></i>';
            document.getElementById('circle').classList.add('active');
            document.getElementById('status').innerText = "משמרת פעילה";

            // התחלת הספירה
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const now = Date.now();
                const diff = now - startTime;
                
                document.getElementById('time').innerText = formatTime(diff);
                
                if(hourlyRate > 0) {
                    const earned = (diff / (1000 * 60 * 60)) * hourlyRate;
                    document.getElementById('money').innerText = "₪" + earned.toFixed(2);
                }
            }, 1000);
        }

        // עזרים
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const h = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const s = (totalSeconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            shifts.forEach(shift => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `
                    <div style="text-align:right">
                        <div class="h-date">${shift.date}</div>
                        <div style="font-size:0.8rem">${shift.start} - ${shift.end}</div>
                    </div>
                    <div style="text-align:left">
                        <div class="h-money">₪${shift.earned.toFixed(2)}</div>
                        <div style="font-size:0.8rem">${shift.totalTime}</div>
                    </div>
                `;
                list.appendChild(li);
            });
        }
        
        function clearHistory() {
            if(confirm('למחוק את כל ההיסטוריה?')) {
                shifts = [];
                localStorage.removeItem('neto_shifts_history');
                renderHistory();
            }
        }
    </script>
</body>
</html>